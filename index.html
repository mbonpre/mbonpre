<!doctype html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Surprise ❤️ — Scannez le QR</title>
    <style>
        :root{--overlay: rgba(0,0,0,0.45);--accent: #ffd1dc}
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
        .wrap{position:relative;height:100vh;overflow:hidden;background:#000}
        
        /* Conteneur du Diaporama */
        .slide-container{position:absolute;inset:0}
        .slide{
            position:absolute;
            inset:0;
            background-size:cover;
            background-position:center;
            opacity:0; /* Caché par défaut */
            transition:opacity 1s ease;
        }
        .slide.active{
            opacity:1; /* La slide active est visible */
        }

        /* calque sombre + contenu */
        .overlay{position:absolute;inset:0;background:var(--overlay);display:flex;align-items:center;justify-content:center;padding:20px}
        .card{max-width:860px;width:100%;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:16px;padding:28px;color:white;backdrop-filter: blur(6px);box-shadow:0 8px 30px rgba(0,0,0,0.5)}

        .top-row{display:flex;align-items:center;gap:12px}
        .avatar{width:64px;height:64px;border-radius:50%;overflow:hidden;flex:0 0 64px;border:2px solid rgba(255,255,255,0.12)}
        /* L'avatar utilise photo1.jpg */
        .avatar img{width:100%;height:100%;object-fit:cover} 
        .title{font-size:18px;margin:0}
        .subtitle{font-size:13px;opacity:0.85}

        .message-box{margin-top:18px;min-height:90px;font-size:20px;line-height:1.3}
        .typing{display:inline-block;white-space:pre-wrap}

        .controls{display:flex;align-items:center;gap:10px;margin-top:18px}
        .btn{padding:9px 12px;border-radius:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);cursor:pointer}
        .progress{flex:1;height:8px;background:rgba(255,255,255,0.08);border-radius:6px;overflow:hidden}
        .fill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#ff9bbf);transition:width 0.15s}

        .small{font-size:13px;opacity:0.9;margin-top:10px}

        /* responsive */
        @media (max-width:600px){.card{padding:18px}.message-box{font-size:17px}}

        /* fade in animation for card */
        .card{transform:translateY(6px);opacity:0;animation:pop 0.6s forwards 0.4s}
        @keyframes pop{to{transform:none;opacity:1}}
    </style>
</head>
<body>
    <div class="wrap">
        
        <div class="slide-container" id="slideshow">
            <div class="slide active" style="background-image: url('im/photo1.jpg');"></div> 
            <div class="slide" style="background-image: url('im/photo2.jpg');"></div>
            <div class="slide" style="background-image: url('im/photo3.jpg');"></div>
        </div>

        <div class="overlay">
            <div class="card">
                <div class="top-row">
                    <div class="avatar"><img id="avatarImg" src="im/photo1.jpg" alt="avatar"></div> 
                    <div>
                        <h3 class="title" id="cardTitle">Pour toi ❤️</h3>
                        <div class="subtitle" id="cardSubtitle">Scanne ce QR pour une surprise</div>
                    </div>
                </div>

                <div class="message-box">
                    <span class="typing" id="typing"></span><span id="cursor">▌</span>
                </div>

                <div class="controls">
                    <button class="btn" id="playBtn">▶️ Play</button>
                    <button class="btn" id="pauseBtn">⏸️ Pause</button>
                    <div class="progress" id="progress"><div class="fill" id="fill"></div></div>
                    <div class="small" id="time">0:00</div>
                </div>

                <div class="small qr-note" id="qrNote">
                    P.S. : Le secret de l'amour est maintenant gravé pour toujours !
                </div>

            </div>
        </div>

        <audio id="bgAudio" preload="auto" src="audio/song.mp3" muted></audio> 
    </div>

    <script>
        /* --- Gestion du Diaporama (Slideshow) --- */
        const slides = document.querySelectorAll('.slide');
        let currentSlide = 0;
        
        function nextSlide() {
            slides[currentSlide].classList.remove('active');
            currentSlide = (currentSlide + 1) % slides.length;
            slides[currentSlide].classList.add('active');
        }

        // Le diaporama tourne toutes les 8 secondes
        let slideInterval = setInterval(nextSlide, 8000); 

        /* --- Messages synchronisés à la musique --- */
        const messages = [
            {at: 0, text: "Mon amour, cette petite surprise est entièrement dédiée à toi."},
            {at: 6, text: "Depuis que nos chemins se sont croisés, ma vie est un poème."},
            {at: 14, text: "Tu es ma lumière, celle qui me guide et m'inspire chaque jour."},
            {at: 23, text: "Chaque rire, chaque silence à tes côtés est un trésor inestimable."},
            {at: 35, text: "Je t'aime plus que les mots ne peuvent le dire."},
            {at: 45, text: "Merci d'être toi, ma moitié parfaite. Pour aujourd'hui et pour toujours. ❤️"}
        ];
        
        // audio & controls
        const audio = document.getElementById('bgAudio');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const typingEl = document.getElementById('typing');
        const cursor = document.getElementById('cursor');
        const fill = document.getElementById('fill');
        const timeEl = document.getElementById('time');

        let shownIndex = -1; 
        let typingTimer = null;
        let showLaunched = false; 
        let attemptPlayCount = 0; // Compteur pour les tentatives de lecture

        function formatTime(s){
            const m = Math.floor(s/60); const sec = Math.floor(s%60).toString().padStart(2,'0');
            return m+':'+sec;
        }
        
        // Fonction pour démarrer la lecture et gérer l'interface
        function startPlayback() {
             // Démarrer la musique (après que le navigateur le permette)
            audio.play(); 
            audio.muted = false; // Démute si la lecture est autorisée
            
            // Lancer le premier message
            if (showLaunched === false) {
                clearInterval(slideInterval);
                slideInterval = setInterval(nextSlide, 8000);
                
                if(messages.length > 0) {
                    shownIndex = 0;
                    typeText(messages[0].text);
                }
                showLaunched = true;
            } 
            
            // Mettre à jour les boutons
            playBtn.disabled = true; 
            playBtn.style.opacity = '0.5'; 
            
        }

        // Tente de démarrer l'audio au chargement (cela réussit souvent si l'audio est muet au départ)
        function attemptPlay() {
            if (attemptPlayCount > 5) return; // Arrêter après 5 tentatives
            attemptPlayCount++;
            audio.play().then(() => {
                // Lecture réussie, le navigateur a accepté
                startPlayback();
            }).catch(error => {
                // Lecture refusée (le navigateur bloque), on réessaie après un court délai
                // On laisse le bouton PLAY comme seule interaction possible.
                playBtn.disabled = false;
                playBtn.style.opacity = '1';
                console.log('Lecture bloquée. Utilisateur doit interagir.');
            });
        }
        
        // Tente de jouer dès que la page est chargée
        document.addEventListener('DOMContentLoaded', () => {
             // Rendre le bouton PLAY disponible au cas où l'autoplay échoue
            playBtn.disabled = false;
            playBtn.style.opacity = '1';
            
            attemptPlay();
        });


        // Écouteur PLAY : Gère le lancement lorsque l'utilisateur clique
        playBtn.addEventListener('click', startPlayback);


        // Écouteur PAUSE : Gère l'arrêt et la réactivation de Play
        pauseBtn.addEventListener('click', ()=>{ 
            audio.pause(); 
            
            // Rendre le bouton Play utilisable après une pause
            playBtn.disabled = false; 
            playBtn.style.opacity = '1'; 
        });

        // mise à jour progress et messages
        audio.addEventListener('timeupdate', ()=>{
            const pct = (audio.currentTime / audio.duration) || 0;
            fill.style.width = (pct*100) + '%';
            timeEl.textContent = formatTime(audio.currentTime);

            // check messages
            for(let i=0;i<messages.length;i++){
                if(audio.currentTime >= messages[i].at && shownIndex < i){
                    shownIndex = i;
                    typeText(messages[i].text);
                }
            }
        });

        audio.addEventListener('ended', ()=>{ cursor.style.opacity='0'; });

        // typing effect
        function typeText(text){
            if(typingTimer) clearInterval(typingTimer);
            typingEl.textContent = '';
            cursor.style.opacity = '1';
            let idx = 0;
            typingTimer = setInterval(()=>{
                typingEl.textContent += text.charAt(idx);
                idx++;
                if(idx >= text.length){
                    clearInterval(typingTimer);
                    typingTimer = null;
                    let blink = 0;
                    const b = setInterval(()=>{ cursor.style.visibility = (cursor.style.visibility === 'hidden' ? 'visible' : 'hidden'); if(++blink>6){ clearInterval(b); cursor.style.visibility='visible'; } }, 300);
                }
            }, 45);
        }
        
    </script>
</body>
</html>
